# WhatsApp Self-Registration (Auto-Cadastro)

## Overview

This feature allows new users to create an account and company directly via WhatsApp, without needing to download the app first. It provides a conversational onboarding flow that guides users through company setup.

## Token Types

| Token | Purpose | Generated By |
|-------|---------|--------------|
| `LT_` | Link existing app user to WhatsApp | User in app (Settings > WhatsApp) |
| `INV_` | Invite collaborator to existing company | Admin/Supervisor via bot or app |
| `RG_` | Self-registration for new companies | System via /bot/registration/start |

## Architecture

### Data Storage

**Registration Tokens:** `/links/registrations/tokens/{RG_xxx}`

```typescript
{
  token: "RG_<uuid>",
  whatsappNumber: "+5511999999999",
  state: "started" | "awaiting_company_name" | "awaiting_segment" |
         "awaiting_subspecialties" | "awaiting_bootstrap" |
         "awaiting_confirm" | "completed" | "cancelled",
  data: {
    companyName?: string,
    segmentId?: string,
    subspecialties?: string[],
    includeBootstrap?: boolean,
    locale?: string
  },
  createdAt: ISO,
  expiresAt: ISO,  // 24h TTL
  completedAt?: ISO,
  userId?: string,
  companyId?: string
}
```

### State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     START       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ POST /registration/start
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ awaiting_company_name   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ POST /registration/update {companyName}
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   awaiting_segment      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ POST /registration/update {segmentId}
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Has subspecs?   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      Yes    â”‚    No
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ awaiting_subspecialtiesâ”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
            â”‚              â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ POST /registration/update {subspecialties}
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   awaiting_bootstrap    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ POST /registration/update {includeBootstrap}
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   awaiting_confirm      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ POST /registration/complete
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      completed          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## API Endpoints

### POST /bot/registration/start

Start a new registration flow.

**Request:**
```json
{
  "locale": "pt-BR"  // optional
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "token": "RG_abc123...",
    "state": "awaiting_company_name",
    "segments": [
      {
        "index": 1,
        "id": "tech-support",
        "name": "AssistÃªncia TÃ©cnica",
        "icon": "ğŸ“±",
        "hasSubspecialties": true,
        "subspecialtiesCount": 5
      }
    ],
    "message": "Registration started. Please provide your company name."
  }
}
```

### POST /bot/registration/update

Update registration data based on current state.

**Request (company name):**
```json
{
  "companyName": "Auto MecÃ¢nica Silva"
}
```

**Request (segment):**
```json
{
  "segmentId": "automotive"
}
```

**Request (subspecialties):**
```json
{
  "subspecialties": ["mechanical", "electrical"]
}
```

**Request (bootstrap):**
```json
{
  "includeBootstrap": true
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "token": "RG_abc123...",
    "state": "awaiting_confirm",
    "data": {
      "companyName": "Auto MecÃ¢nica Silva",
      "segmentId": "automotive",
      "subspecialties": ["mechanical", "electrical"],
      "includeBootstrap": true
    },
    "nextStep": "Please confirm your registration",
    "summary": {
      "companyName": "Auto MecÃ¢nica Silva",
      "segment": { "id": "automotive", "name": "MecÃ¢nica Automotiva" },
      "subspecialties": ["mechanical", "electrical"],
      "includeBootstrap": true
    }
  }
}
```

### POST /bot/registration/complete

Complete the registration and create all entities.

**Response:**
```json
{
  "success": true,
  "data": {
    "userId": "uid123",
    "userName": "Auto MecÃ¢nica Silva",
    "companyId": "cmp456",
    "companyName": "Auto MecÃ¢nica Silva",
    "bootstrapResult": {
      "servicesCreated": 5,
      "productsCreated": 3,
      "customersCreated": 1
    },
    "message": "Registration completed successfully! Welcome to PraticOS."
  }
}
```

### GET /bot/registration/status

Check current registration status.

**Response:**
```json
{
  "success": true,
  "data": {
    "hasActiveRegistration": true,
    "token": "RG_abc123...",
    "state": "awaiting_segment",
    "data": {
      "companyName": "Auto MecÃ¢nica Silva"
    },
    "expiresAt": "2025-01-10T10:00:00Z"
  }
}
```

### DELETE /bot/registration

Cancel active registration.

**Response:**
```json
{
  "success": true,
  "data": {
    "message": "Registration cancelled successfully"
  }
}
```

### GET /bot/registration/segments

List available segments with subspecialties.

**Response:**
```json
{
  "success": true,
  "data": {
    "segments": [
      {
        "index": 1,
        "id": "automotive",
        "name": "MecÃ¢nica Automotiva",
        "icon": "ğŸ”§",
        "subspecialties": [
          { "index": 1, "id": "mechanical", "name": "MecÃ¢nica Geral" },
          { "index": 2, "id": "electrical", "name": "ElÃ©trica Automotiva" }
        ]
      }
    ]
  }
}
```

## Conversation Flow Example

```
User: "Oi"

Bot: (calls GET /bot/link/context, gets linked:false)

Bot: "OlÃ¡! Bem-vindo ao PraticOS! ğŸ‘‹

Como posso ajudar?

1ï¸âƒ£ JÃ¡ tenho conta no app
2ï¸âƒ£ Recebi um convite (cÃ³digo INV_)
3ï¸âƒ£ Quero criar minha empresa

Responda com o nÃºmero da opÃ§Ã£o:"

User: "3"

Bot: (calls POST /bot/registration/start)

Bot: "Vamos criar sua empresa! ğŸ¢

Qual o nome da sua empresa?"

User: "Auto MecÃ¢nica Silva"

Bot: (calls POST /bot/registration/update {companyName})

Bot: "Qual o segmento da sua empresa?

1. ğŸ“± AssistÃªncia TÃ©cnica
2. ğŸ”§ MecÃ¢nica Automotiva
3. ğŸ’» InformÃ¡tica
4. â„ï¸ RefrigeraÃ§Ã£o
...

Responda com o nÃºmero:"

User: "2"

Bot: (calls POST /bot/registration/update {segmentId: "automotive"})

Bot: "Quais suas especialidades? (responda com nÃºmeros separados por vÃ­rgula)

1. MecÃ¢nica geral
2. ElÃ©trica automotiva
3. InjeÃ§Ã£o eletrÃ´nica
4. Freios e suspensÃ£o

Ou responda 'pular' para continuar:"

User: "1,3"

Bot: (calls POST /bot/registration/update {subspecialties: ["mechanical", "injection"]})

Bot: "Deseja criar dados de exemplo (serviÃ§os, produtos, cliente demo)?

1. âœ… Sim, criar dados de exemplo
2. âŒ NÃ£o, comeÃ§ar do zero

Recomendamos a opÃ§Ã£o 1 para conhecer o sistema!"

User: "1"

Bot: (calls POST /bot/registration/update {includeBootstrap: true})

Bot: "ğŸ“‹ Confirma o cadastro?

â€¢ Empresa: Auto MecÃ¢nica Silva
â€¢ Segmento: MecÃ¢nica Automotiva
â€¢ Especialidades: MecÃ¢nica geral, InjeÃ§Ã£o eletrÃ´nica
â€¢ Dados exemplo: Sim

Responda 'sim' para confirmar ou 'cancelar' para desistir."

User: "sim"

Bot: (calls POST /bot/registration/complete)

Bot: "âœ… Cadastro concluÃ­do! Bem-vindo ao PraticOS!

Sua empresa 'Auto MecÃ¢nica Silva' foi criada com sucesso.

Foram criados:
â€¢ 5 serviÃ§os de exemplo
â€¢ 3 produtos de exemplo
â€¢ 1 cliente demo

Agora vocÃª pode:
â€¢ Criar ordens de serviÃ§o
â€¢ Cadastrar clientes
â€¢ Consultar o faturamento

Me envie 'criar OS' para comeÃ§ar!"
```

## What Gets Created

When registration completes, the following entities are created:

1. **Firebase Auth User**
   - Phone number as identifier
   - Display name = company name

2. **User Document** (`/users/{userId}`)
   - name, phone, createdVia: "whatsapp_self_registration"
   - companies array with new company

3. **Company Document** (`/companies/{companyId}`)
   - name, segment, subspecialties, country
   - owner = new user
   - nextOrderNumber = 1

4. **WhatsApp Link** (`/links/whatsapp/numbers/{phone}`)
   - Links phone to user and company
   - role = "owner"

5. **Bootstrap Data** (if includeBootstrap = true)
   - Services from segment bootstrap
   - Products from segment bootstrap
   - Sample customer
   - Form templates from segment

## Security Considerations

1. **Rate Limiting**
   - Max 3 registration attempts per phone per 24 hours
   - Prevents abuse and spam accounts

2. **Token Expiration**
   - Registration tokens expire after 24 hours
   - Incomplete registrations are automatically invalidated

3. **Phone Verification**
   - Phone number is verified by WhatsApp itself
   - No additional verification needed

4. **Atomic Operations**
   - All entity creation happens in sequence
   - If any step fails, cleanup is attempted

## Files

### Created
- `firebase/functions/src/services/registration.service.ts` - Token and state management
- `firebase/functions/src/services/bootstrap-server.service.ts` - Server-side bootstrap
- `firebase/functions/src/routes/bot/registration.routes.ts` - API endpoints

### Modified
- `firebase/functions/src/index.ts` - Route registration
- `firebase/functions/src/routes/bot/link.routes.ts` - pendingRegistration in context
- `backend/bot/workspace/skills/praticos/SKILL.md` - Bot instructions

## Testing

1. Use an unlinked WhatsApp number
2. Send message to bot
3. Select "create company" option
4. Follow the conversation flow
5. Verify in Firebase Console:
   - Auth user created
   - User document created
   - Company document created
   - WhatsApp link created
   - Bootstrap data created (if selected)

## Related Documentation

- `docs/SHARE_LINK.md` - Magic link system (similar token pattern)
- `docs/MULTI_TENANCY.md` - Company structure
- `docs/SEGMENT_CUSTOM_FIELDS.md` - Segment configuration
