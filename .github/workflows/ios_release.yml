name: Release iOS to TestFlight

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  ios:
    runs-on: macos-14
    env:
      BUNDLE_ID: br.com.rafsoft.praticos

    steps:
      - uses: actions/checkout@v4

      # Flutter SDK
      - name: Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: stable
          cache: false

      - name: Flutter deps
        run: flutter pub get

      # Xcode + iOS SDK (necess√°rio na imagem nova)
      - name: Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      # Accept Xcode license
      - name: Accept Xcode license
        run: sudo xcodebuild -license accept

      # Download iOS Platform
      - name: Download iOS Platform
        run: xcodebuild -downloadPlatform iOS

      # Ruby + Bundler
      - name: Ruby (bundler cache)
        uses: ruby/setup-ruby@v1
        env:
          BUNDLE_GEMFILE: ios/Gemfile
        with:
          ruby-version: '3.2'
          bundler-cache: true

      # üîê Importa o certificado .p12 no keychain
      - name: Import distribution cert
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_DIST_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.IOS_DIST_CERTIFICATE_PASSWORD }}

      # üìÑ Instala o .mobileprovision vindo da secret (Base64)
      - name: Install provisioning profile
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          PROFILE="$HOME/Library/MobileDevice/Provisioning Profiles/AppStore.mobileprovision"
          echo -n "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > "$PROFILE"

          /usr/bin/security cms -D -i "$PROFILE" > profile.plist
          NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' profile.plist)
          UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' profile.plist)
          TEAM=$(/usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' profile.plist)

          echo "PROFILE_NAME=$NAME" >> $GITHUB_ENV
          echo "PROFILE_UUID=$UUID" >> $GITHUB_ENV
          echo "DEVELOPMENT_TEAM=$TEAM" >> $GITHUB_ENV

          echo "Using profile: $NAME (UUID $UUID) - TEAM $TEAM"

      # üß© CocoaPods (vai aproveitar os caches acima)
      - name: Pod install
        working-directory: ios
        run: bundle exec pod install --repo-update

      # üìÑ Adiciona o GoogleService-Info.plist
      - name: Add GoogleService-Info.plist
        working-directory: ios
        shell: bash
        run: |
          set -euo pipefail
          echo -n "${{ secrets.IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64 }}" | base64 --decode > GoogleService-Info.plist
          # valida sintaxe do plist (opcional, ajuda a detectar secret errado)
          /usr/bin/plutil -lint GoogleService-Info.plist
          echo "GoogleService-Info.plist criado em ios/"

      # üî¢ Busca o √∫ltimo build number do TestFlight e incrementa
      - name: Get next build number
        id: build_number
        working-directory: ios
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_PRIVATE_KEY }}
          BUNDLE_ID: ${{ env.BUNDLE_ID }}
        run: |
          bundle exec fastlane get_next_build_number
          NEXT_BUILD=$(cat ../next_build_number.txt)
          echo "Next build number: $NEXT_BUILD"
          echo "BUILD_NUMBER=$NEXT_BUILD" >> $GITHUB_OUTPUT

      # üìÑ Gera ExportOptions.plist para o Flutter build
      - name: Generate ExportOptions.plist
        env:
          BUNDLE_ID: ${{ env.BUNDLE_ID }}
        run: |
          cat > ios/ExportOptions.plist <<PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>$DEVELOPMENT_TEAM</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>$BUNDLE_ID</key>
                  <string>$PROFILE_NAME</string>
              </dict>
              <key>uploadSymbols</key>
              <true/>
          </dict>
          </plist>
          PLIST
          echo "ExportOptions.plist created with TEAM=$DEVELOPMENT_TEAM"

      # üèóÔ∏è Flutter build com build number incrementado
      - name: Flutter build IPA
        run: |
          flutter build ipa \
            --release \
            --build-number=${{ steps.build_number.outputs.BUILD_NUMBER }} \
            --export-options-plist=ios/ExportOptions.plist

      # üöÄ Upload para TestFlight via Fastlane
      - name: Fastlane upload
        working-directory: ios
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_PRIVATE_KEY }}
          BUNDLE_ID: ${{ env.BUNDLE_ID }}
          DEVELOPMENT_TEAM: ${{ env.DEVELOPMENT_TEAM }}
          PROFILE_UUID: ${{ env.PROFILE_UUID }}
          PROFILE_NAME: ${{ env.PROFILE_NAME }}
          FASTLANE_SKIP_UPDATE_CHECK: "true"
          CI: "true"
        run: bundle exec fastlane upload

      - name: Upload fastlane logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fastlane-logs
          path: |
            $HOME/Library/Logs/fastlane/fastlane.log
            ios/fastlane/report.xml
