name: Release iOS

on:
  push:
    tags:
      - 'v*-rc'  # Only trigger on RC tags
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v1.0.0-rc)'
        required: false
        type: string

# Only one iOS release at a time - cancel previous if new one starts
concurrency:
  group: ios-release
  cancel-in-progress: true

jobs:
  ios:
    runs-on: macos-14
    env:
      BUNDLE_ID: br.com.rafsoft.praticos

    outputs:
      version_name: ${{ steps.version.outputs.version_name }}

    steps:
      # Determine which tag to use (input takes priority over ref)
      - name: Determine tag
        id: get_tag
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Using tag: $TAG"

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.get_tag.outputs.tag }}

      # Extract version from tag
      - name: Extract version from tag
        id: version
        run: |
          TAG="${{ steps.get_tag.outputs.tag }}"
          # Remove 'v' prefix and '-rc' suffix
          VERSION="${TAG#v}"
          VERSION="${VERSION%-rc}"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version: $VERSION from tag: $TAG"

      # Flutter SDK
      - name: Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: stable
          cache: true # Ativa o cache do SDK

      - name: Cache Pub deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Flutter deps
        run: flutter pub get

      # Xcode + iOS SDK (necessÃ¡rio na imagem nova)
      - name: Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      # Accept Xcode license
      - name: Accept Xcode license
        run: sudo xcodebuild -license accept

      # Download iOS Platform
      - name: Download iOS Platform
        run: xcodebuild -downloadPlatform iOS

      # Ruby + Bundler
      - name: Ruby (bundler cache)
        uses: ruby/setup-ruby@v1
        env:
          BUNDLE_GEMFILE: ios/Gemfile
        with:
          ruby-version: '3.2'
          bundler-cache: true

      # ðŸ” Importa o certificado .p12 no keychain
      - name: Import distribution cert
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_DIST_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.IOS_DIST_CERTIFICATE_PASSWORD }}

      # ðŸ“„ Instala o .mobileprovision vindo da secret (Base64)
      - name: Install provisioning profile
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          PROFILE="$HOME/Library/MobileDevice/Provisioning Profiles/AppStore.mobileprovision"
          echo -n "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > "$PROFILE"

          /usr/bin/security cms -D -i "$PROFILE" > profile.plist
          NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' profile.plist)
          UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' profile.plist)
          TEAM=$(/usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' profile.plist)

          echo "PROFILE_NAME=$NAME" >> $GITHUB_ENV
          echo "PROFILE_UUID=$UUID" >> $GITHUB_ENV
          echo "DEVELOPMENT_TEAM=$TEAM" >> $GITHUB_ENV

          echo "Using profile: $NAME (UUID $UUID) - TEAM $TEAM"

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      # ðŸ§© CocoaPods
      - name: Pod install
        working-directory: ios
        run: |
          if [ ! -d "Pods" ]; then
            bundle exec pod install --repo-update
          else
            bundle exec pod install
          fi

      # ðŸ“„ Adiciona o GoogleService-Info.plist
      - name: Add GoogleService-Info.plist
        working-directory: ios
        shell: bash
        run: |
          set -euo pipefail
          echo -n "${{ secrets.IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64 }}" | base64 --decode > GoogleService-Info.plist
          # valida sintaxe do plist (opcional, ajuda a detectar secret errado)
          /usr/bin/plutil -lint GoogleService-Info.plist
          echo "GoogleService-Info.plist criado em ios/"

      # ðŸš€ Build + upload para TestFlight
      - name: Fastlane Beta (TestFlight)
        working-directory: ios
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_PRIVATE_KEY }}
          BUNDLE_ID: ${{ env.BUNDLE_ID }}
          DEVELOPMENT_TEAM: ${{ env.DEVELOPMENT_TEAM }}
          PROFILE_UUID: ${{ env.PROFILE_UUID }}
          PROFILE_NAME: ${{ env.PROFILE_NAME }}
          FASTLANE_SKIP_UPDATE_CHECK: "true"
          CI: "true"
        run: bundle exec fastlane beta

      # ðŸ“¦ Find and rename IPA for upload
      - name: Prepare IPA for upload
        id: ipa
        run: |
          # Find the IPA file (Fastlane generates it in ios/ directory)
          IPA_PATH=$(find ios -name "*.ipa" -type f | head -1)

          if [ -z "$IPA_PATH" ]; then
            echo "âŒ No IPA file found!"
            exit 1
          fi

          echo "Found IPA: $IPA_PATH"
          echo "ipa_path=$IPA_PATH" >> $GITHUB_OUTPUT

      # ðŸ“¦ Upload IPA to GitHub Release
      - name: Upload IPA to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: "Release ${{ steps.version.outputs.version_name }} (RC)"
          draft: false
          prerelease: true
          files: |
            ${{ steps.ipa.outputs.ipa_path }}
          body: |
            ## iOS Release Candidate

            **Version:** ${{ steps.version.outputs.version_name }}
            **Tag:** ${{ steps.get_tag.outputs.tag }}

            This is a release candidate deployed to TestFlight.

            To promote to production, use the "Promote Release" workflow.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload fastlane logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fastlane-logs
          path: |
            $HOME/Library/Logs/fastlane/fastlane.log
            ios/fastlane/report.xml
