name: Release Android

on:
  push:
    tags:
      - 'v*-rc'  # Only trigger on RC tags
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v1.0.0-rc)'
        required: false
        type: string

# Only one Android release at a time - cancel previous if new one starts
concurrency:
  group: android-release
  cancel-in-progress: true

jobs:
  android:
    runs-on: ubuntu-latest

    outputs:
      version_name: ${{ steps.version.outputs.version_name }}
      version_code: ${{ steps.version.outputs.version_code }}

    steps:
      # Determine which tag to use (input takes priority over ref)
      - name: Determine tag
        id: get_tag
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Using tag: $TAG"

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.get_tag.outputs.tag }}

      # Extract version from tag
      - name: Extract version from tag
        id: version
        run: |
          TAG="${{ steps.get_tag.outputs.tag }}"
          # Remove 'v' prefix and '-rc' suffix
          VERSION="${TAG#v}"
          VERSION="${VERSION%-rc}"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version: $VERSION from tag: $TAG"

      # Setup Java
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      # Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: stable
          cache: true

      - name: Flutter deps
        run: flutter pub get

      # Setup Ruby + Bundler
      - name: Ruby (bundler cache)
        uses: ruby/setup-ruby@v1
        env:
          BUNDLE_GEMFILE: android/Gemfile
        with:
          ruby-version: '3.2'
          bundler-cache: true

      # ðŸ” Restore Secrets
      
      - name: Make gradlew executable
        run: chmod +x gradlew

      # 1. Keystore
      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/rafsoft.keystore

      # 2. Google Play Credentials
      - name: Decode Play Store Credentials
        run: |
          echo "${{ secrets.ANDROID_PLAY_STORE_CREDENTIALS_BASE64 }}" | base64 --decode > android/fastlane/play_store_credentials.json

      # 3. Google Services JSON
      - name: Decode Google Services JSON
        run: |
          echo "${{ secrets.ANDROID_GOOGLE_SERVICES_JSON_BASE64 }}" | base64 --decode > android/app/google-services.json

      # ðŸš€ Build + Upload to Internal Track
      - name: Fastlane Internal (Google Play)
        id: fastlane
        working-directory: android
        env:
          FASTLANE_SKIP_UPDATE_CHECK: "true"
          CI: "true"
        run: bundle exec fastlane internal

      # ðŸ“¦ Upload AAB to GitHub Release
      - name: Upload AAB to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: "Release ${{ steps.version.outputs.version_name }} (RC)"
          draft: false
          prerelease: true
          files: |
            build/app/outputs/bundle/release/app-release.aab
          body: |
            ## Android Release Candidate

            **Version:** ${{ steps.version.outputs.version_name }}
            **Tag:** ${{ steps.get_tag.outputs.tag }}

            This is a release candidate deployed to Google Play Internal Track.

            To promote to production, use the "Promote Release" workflow.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
