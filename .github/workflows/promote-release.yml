name: Promote Release to Production

on:
  workflow_dispatch:
    inputs:
      skip_android:
        description: 'Skip Android promotion'
        required: false
        type: boolean
        default: false
      skip_ios:
        description: 'Skip iOS promotion'
        required: false
        type: boolean
        default: false
      upload_screenshots:
        description: 'Upload screenshots to stores (overrides auto-detection)'
        required: false
        type: boolean
        default: true

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      rc_tag: ${{ steps.validate.outputs.rc_tag }}
      prod_tag: ${{ steps.validate.outputs.prod_tag }}
      version: ${{ steps.validate.outputs.version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate RC tag
        id: validate
        run: |
          GIT_REF="${{ github.ref_name }}"

          # Detect RC tag from GitHub UI selection or use latest
          if [[ "$GIT_REF" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-rc$ ]]; then
            RC_TAG="$GIT_REF"
            echo "ðŸ“Œ Using selected tag: $RC_TAG"
          else
            echo "ðŸ“Œ Fetching latest -rc tag..."
            RC_TAG=$(git tag -l 'v*-rc' | sort -V | tail -1)

            if [ -z "$RC_TAG" ]; then
              echo "âŒ No -rc tags found"
              exit 1
            fi

            echo "ðŸ“Œ Using latest RC tag: $RC_TAG"
          fi

          # Validate format
          if [[ ! "$RC_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-rc$ ]]; then
            echo "âŒ Invalid tag format. Must be like v1.0.3-rc"
            exit 1
          fi

          # Check if RC tag exists
          if ! git rev-parse "$RC_TAG" >/dev/null 2>&1; then
            echo "âŒ Tag $RC_TAG not found"
            exit 1
          fi

          # Calculate production tag
          PROD_TAG="${RC_TAG%-rc}"
          VERSION="${PROD_TAG#v}"

          # Check if production tag already exists
          if git rev-parse "$PROD_TAG" >/dev/null 2>&1; then
            echo "âŒ Production tag $PROD_TAG already exists"
            exit 1
          fi

          echo "rc_tag=$RC_TAG" >> $GITHUB_OUTPUT
          echo "prod_tag=$PROD_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "âœ… Promoting $RC_TAG â†’ $PROD_TAG"

  promote-android:
    needs: validate
    if: ${{ !inputs.skip_android }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Check for Metadata/Screenshot changes since RC tag
      - name: Check for metadata changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          base: ${{ needs.validate.outputs.rc_tag }}
          filters: |
            screenshots:
              - 'android/fastlane/metadata/android/*/images/**'
            metadata:
              - 'android/fastlane/metadata/**'

      - name: Log metadata status
        run: |
          echo "ðŸ“¸ Screenshots changed: ${{ steps.filter.outputs.screenshots }}"
          echo "ðŸ“ Metadata changed: ${{ steps.filter.outputs.metadata }}"
          echo "ðŸŽ¯ Upload screenshots input: ${{ inputs.upload_screenshots }}"

          # Determine if screenshots should be uploaded
          if [[ "${{ inputs.upload_screenshots }}" == "true" ]]; then
            echo "âœ… Screenshots WILL be uploaded (manual override enabled)"
          elif [[ "${{ steps.filter.outputs.screenshots }}" == "true" ]]; then
            echo "âœ… Screenshots WILL be uploaded (changes detected)"
          else
            echo "â­ï¸  Screenshots will be SKIPPED (no changes detected and manual override disabled)"
          fi

      # Setup Ruby + Bundler
      - name: Ruby (bundler cache)
        uses: ruby/setup-ruby@v1
        env:
          BUNDLE_GEMFILE: android/Gemfile
        with:
          ruby-version: '3.2'
          bundler-cache: true

      # Decode Play Store Credentials
      - name: Decode Play Store Credentials
        run: |
          echo "${{ secrets.ANDROID_PLAY_STORE_CREDENTIALS_BASE64 }}" | base64 --decode > android/fastlane/play_store_credentials.json

      # Promote Internal to Production (no rebuild, no re-upload!)
      - name: Promote to Production
        working-directory: android
        env:
          FASTLANE_SKIP_UPDATE_CHECK: "true"
          CI: "true"
        run: |
          bundle exec fastlane promote_to_production \
            skip_screenshots:${{ inputs.upload_screenshots == false && steps.filter.outputs.screenshots == 'false' }}

      - name: Summary
        run: |
          SCREENSHOTS_UPLOADED="${{ inputs.upload_screenshots == true || steps.filter.outputs.screenshots == 'true' }}"
          echo "âœ… Android promoted to production!"
          echo "   - Metadata uploaded: ${{ steps.filter.outputs.metadata }}"
          echo "   - Screenshots uploaded: $SCREENSHOTS_UPLOADED"

  promote-ios:
    needs: validate
    if: ${{ !inputs.skip_ios }}
    runs-on: macos-14
    env:
      BUNDLE_ID: br.com.rafsoft.praticos

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Check for Metadata/Screenshot changes since RC tag
      - name: Check for metadata changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          base: ${{ needs.validate.outputs.rc_tag }}
          filters: |
            screenshots:
              - 'ios/fastlane/screenshots/**'
            metadata:
              - 'ios/fastlane/metadata/**'

      - name: Log metadata status
        run: |
          echo "ðŸ“¸ Screenshots changed: ${{ steps.filter.outputs.screenshots }}"
          echo "ðŸ“ Metadata changed: ${{ steps.filter.outputs.metadata }}"
          echo "ðŸŽ¯ Upload screenshots input: ${{ inputs.upload_screenshots }}"

          # Determine if screenshots should be uploaded
          if [[ "${{ inputs.upload_screenshots }}" == "true" ]]; then
            echo "âœ… Screenshots WILL be uploaded (manual override enabled)"
          elif [[ "${{ steps.filter.outputs.screenshots }}" == "true" ]]; then
            echo "âœ… Screenshots WILL be uploaded (changes detected)"
          else
            echo "â­ï¸  Screenshots will be SKIPPED (no changes detected and manual override disabled)"
          fi

      # Setup Ruby + Bundler
      - name: Ruby (bundler cache)
        uses: ruby/setup-ruby@v1
        env:
          BUNDLE_GEMFILE: ios/Gemfile
        with:
          ruby-version: '3.2'
          bundler-cache: true

      # Promote TestFlight build to App Store (no rebuild, no re-upload!)
      - name: Promote to App Store
        working-directory: ios
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_PRIVATE_KEY }}
          FASTLANE_SKIP_UPDATE_CHECK: "true"
          CI: "true"
        run: |
          bundle exec fastlane promote \
            app_version:${{ needs.validate.outputs.version }} \
            skip_screenshots:${{ inputs.upload_screenshots == false && steps.filter.outputs.screenshots == 'false' }}

      - name: Summary
        run: |
          SCREENSHOTS_UPLOADED="${{ inputs.upload_screenshots == true || steps.filter.outputs.screenshots == 'true' }}"
          echo "âœ… iOS promoted to App Store!"
          echo "   - Metadata uploaded: ${{ steps.filter.outputs.metadata }}"
          echo "   - Screenshots uploaded: $SCREENSHOTS_UPLOADED"

  create-production-tag:
    needs: [validate, promote-android, promote-ios]
    # Run even if one platform was skipped
    if: always() && needs.validate.result == 'success' && (needs.promote-android.result == 'success' || needs.promote-android.result == 'skipped') && (needs.promote-ios.result == 'success' || needs.promote-ios.result == 'skipped')
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Create production tag
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          RC_TAG="${{ needs.validate.outputs.rc_tag }}"
          PROD_TAG="${{ needs.validate.outputs.prod_tag }}"

          # Get the commit from RC tag
          COMMIT=$(git rev-list -n 1 "$RC_TAG")

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Configure remote with PAT
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git

          # Create production tag pointing to the same commit
          git tag -a "$PROD_TAG" "$COMMIT" -m "Production release $PROD_TAG (promoted from $RC_TAG)"
          git push origin "$PROD_TAG"

          echo "ðŸ·ï¸ Created production tag: $PROD_TAG"

      - name: Create or Update GitHub Release
        run: |
          PROD_TAG="${{ needs.validate.outputs.prod_tag }}"
          RC_TAG="${{ needs.validate.outputs.rc_tag }}"
          VERSION="${{ needs.validate.outputs.version }}"

          RELEASE_NOTES="## Production Release

          **Version:** $VERSION
          **Promoted from:** $RC_TAG

          This release has been promoted to production on both Google Play and App Store."

          # Check if release exists, create or edit accordingly
          if gh release view "$RC_TAG" &>/dev/null; then
            echo "ðŸ“ Updating existing release $RC_TAG..."
            gh release edit "$RC_TAG" \
              --title "Release $VERSION" \
              --prerelease=false \
              --notes "$RELEASE_NOTES"
          else
            echo "ðŸ“¦ Creating new release for $RC_TAG..."
            gh release create "$RC_TAG" \
              --title "Release $VERSION" \
              --notes "$RELEASE_NOTES"
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸš€ Promotion Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| RC Tag | ${{ needs.validate.outputs.rc_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Production Tag | ${{ needs.validate.outputs.prod_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.validate.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The same binaries that were tested in RC are now in production!" >> $GITHUB_STEP_SUMMARY
