rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Função auxiliar para verificar se o usuário está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Função para validar tipo e tamanho de imagem
    function isValidImage() {
      // Permite se não houver contentType OU se for uma imagem
      return (request.resource.contentType == null ||
              request.resource.contentType.matches('image/.*')) &&
             request.resource.size < 10 * 1024 * 1024; // 10MB max
    }

    // NOTA: Validação completa de tenant requer Custom Claims ou subcoleção
    // Por enquanto, a validação de tenant é feita client-side no PhotoService
    // TODO: Implementar Custom Claims com companyId no Firebase Auth token

    // Regra para permitir listar e deletar toda a pasta de um tenant (para delete account)
    match /tenants/{companyId}/{allPaths=**} {
      allow read, list: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Regra para logo da empresa (usado no onboarding e delete account)
    match /companies/{companyId}/{allPaths=**} {
      allow read, list: if isAuthenticated();
      allow create, update: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated();
    }

    // Regras para fotos de ordens de serviço organizadas por tenant
    match /tenants/{companyId}/orders/{orderId}/photos/{photoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isValidImage();
      allow update: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated();
    }

    match /tenants/{companyId}/orders/{orderId}/photos {
      allow list: if isAuthenticated();
    }

    // Regras para fotos de formulários dentro de ordens de serviço
    match /tenants/{companyId}/orders/{orderId}/forms/{formId}/{photoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isValidImage();
      allow update: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated();
    }

    match /tenants/{companyId}/orders/{orderId}/forms/{formId} {
      allow list: if isAuthenticated();
    }

    // Regras para fotos de produtos
    match /tenants/{companyId}/products/{productId}/{photoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isValidImage();
      allow update: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated();
    }

    // Regras para fotos de serviços
    match /tenants/{companyId}/services/{serviceId}/{photoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isValidImage();
      allow update: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated();
    }

    // Regras para fotos de veículos/dispositivos
    match /tenants/{companyId}/devices/{deviceId}/{photoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isValidImage();
      allow update: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated();
    }

    // Regras para logo da empresa
    match /tenants/{companyId}/logo/{logoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isValidImage();
      allow update: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated();
    }

    // Regras para fotos de perfil de usuários
    match /tenants/{companyId}/users/{userId}/{photoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isValidImage();
      allow update: if isAuthenticated() && isValidImage();
      allow delete: if isAuthenticated();
    }

    // Bloqueia acesso a qualquer outro caminho não especificado
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
