rules_version = '2';
service cloud.firestore {

  match /databases/{database}/documents {

    // ════════════════════════════════════════════════════════════════════════
    // HELPER FUNCTIONS
    // ════════════════════════════════════════════════════════════════════════

    // Verifica se o usuário pertence à empresa usando custom claims
    // Claims structure: { roles: { 'companyId': 'admin' | 'manager' | 'user' } }
    function belongsToCompany(companyId) {
      return request.auth != null
        && request.auth.token.roles != null
        && request.auth.token.roles[companyId] != null;
    }

    // Verifica se o usuário tem uma role específica na empresa
    function hasRole(companyId, role) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] == role;
    }

    // Verifica se o usuário é admin da empresa
    function isCompanyAdmin(companyId) {
      return hasRole(companyId, 'admin');
    }

    // Verifica se o usuário é admin ou manager da empresa
    function canManage(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'manager'];
    }

    // Verifica se é o owner da empresa (para estrutura legada)
    function isOwner() {
      return request.auth != null
        && resource.data.company.id == request.auth.uid;
    }

    // Verifica se é o owner da empresa (para create)
    function isOwnerOnCreate() {
      return request.auth != null
        && request.resource.data.company['id'] == request.auth.uid;
    }

    // ════════════════════════════════════════════════════════════════════════
    // GLOBAL COLLECTIONS
    // ════════════════════════════════════════════════════════════════════════

    // Users - global collection (usuário pode pertencer a múltiplas empresas)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Invites - convites para colaboradores
    // Qualquer membro admin/manager de uma empresa pode criar convites
    // O convidado pode ler convites direcionados ao seu email
    // O convidado pode atualizar status (aceitar/rejeitar)
    match /invites/{inviteId} {
      // Permite criar se autenticado e é admin/manager da empresa do convite
      allow create: if request.auth != null
        && request.resource.data.company != null
        && request.resource.data.company.id != null
        && canManage(request.resource.data.company.id);

      // Permite ler se é o dono do convite (email) ou admin/manager da empresa
      // Nota: novos usuários podem não ter claims ainda, então verificamos email diretamente
      allow read: if request.auth != null
        && (
          request.auth.token.email == resource.data.email
          || (
            resource.data.company != null
            && resource.data.company.id != null
            && request.auth.token.roles != null
            && request.auth.token.roles[resource.data.company.id] in ['admin', 'manager']
          )
        );

      // Permite atualizar status se é o dono do convite (email)
      allow update: if request.auth != null
        && request.auth.token.email == resource.data.email
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']);

      // Permite deletar se é admin/manager da empresa
      allow delete: if request.auth != null
        && resource.data.company != null
        && resource.data.company.id != null
        && request.auth.token.roles != null
        && request.auth.token.roles[resource.data.company.id] in ['admin', 'manager'];
    }

    // Segments - global collection (read-only para usuários autenticados)
    match /segments/{segmentId} {
      allow read: if request.auth != null;
      allow write: if false; // Apenas via Admin SDK (script de seed)

      // Formulários globais do segmento (read-only)
      match /forms/{formId} {
        allow read: if request.auth != null;
        allow write: if false; // Apenas via Admin SDK (script de seed)
      }
    }

    // ════════════════════════════════════════════════════════════════════════
    // LEGACY STRUCTURE (manter durante migração)
    // Remover após cleanup completo
    // ════════════════════════════════════════════════════════════════════════

    match /companies/{id} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && (
        resource.data.owner == request.auth.uid || 
        (resource.data.owner is map && resource.data.owner.id == request.auth.uid)
      );
    }

    match /customers/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /devices/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /orders/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /products/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /services/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /roles/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    // ════════════════════════════════════════════════════════════════════════
    // NEW SUBCOLLECTION STRUCTURE
    // Usa custom claims para verificação de acesso
    // ════════════════════════════════════════════════════════════════════════

    match /companies/{companyId} {
      // Documento da empresa - membros podem ler, apenas owner pode escrever
      allow read: if belongsToCompany(companyId)
        || resource.data.owner == request.auth.uid
        || (resource.data.owner is map && resource.data.owner.id == request.auth.uid);
      
      allow write: if request.auth != null
        && (
          resource.data.owner == request.auth.uid 
          || (resource.data.owner is map && resource.data.owner.id == request.auth.uid)
        );

      // ──────────────────────────────────────────────────────────────────────
      // Subcollections - isoladas automaticamente por tenant
      // ──────────────────────────────────────────────────────────────────────

      match /orders/{orderId} {
        allow read, write: if belongsToCompany(companyId);

        // Subcollection de fotos dentro de orders
        match /photos/{photoId} {
          allow read, write: if belongsToCompany(companyId);
        }

        // Subcollection de formulários dentro de orders
        match /forms/{formId} {
          allow read, write: if belongsToCompany(companyId);
        }
      }

      match /customers/{customerId} {
        allow read, write: if belongsToCompany(companyId);
      }

      match /devices/{deviceId} {
        allow read, write: if belongsToCompany(companyId);
      }

      match /products/{productId} {
        allow read, write: if belongsToCompany(companyId);
      }

      match /services/{serviceId} {
        allow read, write: if belongsToCompany(companyId);
      }

      match /memberships/{memberId} {
        allow read: if belongsToCompany(companyId);
        // Permite criar seu próprio membership (signup) ou owner/admin gerenciar outros
        allow create: if request.auth != null
          && (
            request.auth.uid == memberId  // Self-membership (signup)
            || isCompanyAdmin(companyId)
          );
        // Update/delete apenas owner ou admin
        allow update, delete: if request.auth != null
          && (
            get(/databases/$(database)/documents/companies/$(companyId)).data.owner.id == request.auth.uid
            || isCompanyAdmin(companyId)
          );
      }

      match /brands/{brandId} {
        allow read, write: if belongsToCompany(companyId);
      }

      match /deviceCatalog/{itemId} {
        allow read, write: if belongsToCompany(companyId);
      }

      // Templates de formulários da empresa
      match /forms/{formId} {
        allow read, write: if belongsToCompany(companyId);
      }

      // Legado: form_templates (pode ser removido após migração)
      match /form_templates/{formId} {
        allow read, write: if belongsToCompany(companyId);
      }
    }
  }
}
