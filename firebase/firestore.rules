rules_version = '2';
service cloud.firestore {

  match /databases/{database}/documents {

    // ════════════════════════════════════════════════════════════════════════
    // HELPER FUNCTIONS - RBAC (Role-Based Access Control)
    // ════════════════════════════════════════════════════════════════════════
    //
    // User roles in PraticOS:
    // - admin: Administrator - Full system access
    // - manager: Manager (Financial) - Financial management
    // - supervisor: Supervisor - Operational management
    // - consultant: Consultant (Sales) - Commercial profile
    // - technician: Technician - Service execution
    // ════════════════════════════════════════════════════════════════════════

    // Verifica se o usuário pertence à empresa usando custom claims
    function belongsToCompany(companyId) {
      return request.auth != null
        && request.auth.token.roles != null
        && request.auth.token.roles[companyId] != null;
    }

    // Verifica se o usuário tem uma role específica na empresa
    function hasRole(companyId, role) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] == role;
    }

    // Verifica se o usuário é admin da empresa
    function isCompanyAdmin(companyId) {
      return hasRole(companyId, 'admin');
    }

    // Verifica se o usuário pode gerenciar a empresa (admin apenas)
    function canManageCompany(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] == 'admin';
    }

    // Verifica se o usuário pode gerenciar dispositivos (admin ou supervisor)
    function canManageDevices(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'supervisor'];
    }

    // Verifica se o usuário pode gerenciar clientes (admin, supervisor ou consultant)
    function canManageCustomers(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'supervisor', 'consultant'];
    }

    // Verifica se o usuário pode visualizar dados financeiros (admin ou manager)
    function canViewFinancial(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'manager'];
    }

    // Verifica se o usuário pode gerenciar usuários (apenas admin)
    function canManageUsers(companyId) {
      return isCompanyAdmin(companyId);
    }

    // Verifica se o usuário pode criar/editar OS (admin, supervisor, consultant, technician)
    function canManageOrders(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'supervisor', 'consultant', 'technician'];
    }

    // Verifica se o usuário pode executar OS (todos os perfis)
    function canExecuteOrders(companyId) {
      return belongsToCompany(companyId);
    }

    // Verifica se o usuário pode atribuir técnicos (admin, supervisor)
    function canAssignOrders(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'supervisor'];
    }

    // Verifica se o usuário pode gerenciar templates (admin, supervisor)
    function canManageTemplates(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'supervisor'];
    }

    // Verifica se é o owner da empresa (para estrutura legada)
    function isOwner() {
      return request.auth != null
        && resource.data.company.id == request.auth.uid;
    }

    // Verifica se é o owner da empresa (para create)
    function isOwnerOnCreate() {
      return request.auth != null
        && request.resource.data.company['id'] == request.auth.uid;
    }

    // ════════════════════════════════════════════════════════════════════════
    // GLOBAL COLLECTIONS
    // ════════════════════════════════════════════════════════════════════════

    // Users - global collection (usuário pode pertencer a múltiplas empresas)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Invites - convites para colaboradores
    // Apenas admin pode criar/gerenciar convites (conforme RBAC: PermissionType.manageUsers)
    // O convidado pode ler convites direcionados ao seu email
    // O convidado pode atualizar status (aceitar/rejeitar)
    match /invites/{inviteId} {
      // Permite criar se autenticado e é admin da empresa do convite
      allow create: if request.auth != null
        && request.resource.data.company != null
        && request.resource.data.company.id != null
        && canManageUsers(request.resource.data.company.id);

      // Permite ler se é o dono do convite (email) ou admin da empresa
      // Nota: novos usuários podem não ter claims ainda, então verificamos email diretamente
      allow read: if request.auth != null
        && (
          request.auth.token.email == resource.data.email
          || (
            resource.data.company != null
            && resource.data.company.id != null
            && canManageUsers(resource.data.company.id)
          )
        );

      // Permite atualizar status se é o dono do convite (email)
      allow update: if request.auth != null
        && request.auth.token.email == resource.data.email
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']);

      // Permite deletar se é admin da empresa
      allow delete: if request.auth != null
        && resource.data.company != null
        && resource.data.company.id != null
        && canManageUsers(resource.data.company.id);
    }

    // Share Tokens - magic links para clientes acompanharem OS
    // Path: /links/share/tokens/{tokenId}
    // Acesso principal é via Cloud Functions (Admin SDK)
    // Usuários autenticados podem ler tokens das suas empresas
    match /links/share/tokens/{tokenId} {
      // Leitura: membro da empresa pode ver tokens da empresa
      allow read: if request.auth != null
        && resource.data.companyId != null
        && belongsToCompany(resource.data.companyId);

      // Escrita: apenas via Cloud Functions (Admin SDK)
      // Usuários não podem criar/editar tokens diretamente
      allow write: if false;
    }

    // Invite Tokens - convites unificados para colaboradores
    // Path: /links/invites/tokens/{token}
    // Suporta convites via app e WhatsApp
    match /links/invites/tokens/{token} {
      // Criação: membro da empresa com permissão de gerenciar usuários (admin)
      // Também permite se o usuário pertence à empresa do convite
      allow create: if request.auth != null
        && request.resource.data.company != null
        && request.resource.data.company.id != null
        && belongsToCompany(request.resource.data.company.id);

      // Leitura: membro da empresa OU destinatário (por email/phone)
      allow read: if request.auth != null
        && (
          // Membro da empresa pode ver convites da empresa
          (resource.data.company != null
            && resource.data.company.id != null
            && belongsToCompany(resource.data.company.id))
          // Destinatário pode ver convites pelo seu email
          || request.auth.token.email == resource.data.email
        );

      // Atualização: destinatário pode aceitar/rejeitar, membro da empresa pode cancelar
      allow update: if request.auth != null
        && (
          // Destinatário pode mudar status para accepted/rejected
          (request.auth.token.email == resource.data.email
            && request.resource.data.diff(resource.data).affectedKeys()
                .hasOnly(['status', 'acceptedAt', 'acceptedByUserId', 'acceptedByUserName']))
          // Membro da empresa pode cancelar
          || (resource.data.company != null
              && resource.data.company.id != null
              && belongsToCompany(resource.data.company.id))
        );

      // Deleção: apenas admin da empresa
      allow delete: if request.auth != null
        && resource.data.company != null
        && resource.data.company.id != null
        && canManageUsers(resource.data.company.id);
    }

    // Auth Tokens - login tokens para WhatsApp -> App
    // Path: /links/auth/tokens/{token}
    // Escrita apenas via Cloud Functions (Admin SDK)
    match /links/auth/tokens/{token} {
      allow read: if false;  // Apenas via Cloud Functions
      allow write: if false; // Apenas via Cloud Functions
    }

    // Segments - global collection (read-only para usuários autenticados)
    match /segments/{segmentId} {
      allow read: if request.auth != null;
      allow write: if false; // Apenas via Admin SDK (script de seed)

      // Formulários globais do segmento (read-only)
      match /forms/{formId} {
        allow read: if request.auth != null;
        allow write: if false; // Apenas via Admin SDK (script de seed)
      }
    }

    // ════════════════════════════════════════════════════════════════════════
    // LEGACY STRUCTURE (manter durante migração)
    // Remover após cleanup completo
    // ════════════════════════════════════════════════════════════════════════

    match /companies/{id} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && (
        resource.data.owner == request.auth.uid ||
        (resource.data.owner is map && resource.data.owner.id == request.auth.uid)
      );
    }

    match /customers/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /devices/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /orders/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /products/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /services/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /roles/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    // ════════════════════════════════════════════════════════════════════════
    // NEW SUBCOLLECTION STRUCTURE - RBAC
    // Usa custom claims para verificação de acesso granular
    // ════════════════════════════════════════════════════════════════════════

    match /companies/{companyId} {
      // Documento da empresa - membros podem ler, apenas owner/admin pode escrever
      allow read: if belongsToCompany(companyId)
        || resource.data.owner == request.auth.uid
        || (resource.data.owner is map && resource.data.owner.id == request.auth.uid);

      allow write: if request.auth != null
        && (
          resource.data.owner == request.auth.uid
          || (resource.data.owner is map && resource.data.owner.id == request.auth.uid)
          || isCompanyAdmin(companyId)
        );

      // ──────────────────────────────────────────────────────────────────────
      // ORDENS DE SERVIÇO
      // Acesso baseado em perfil:
      // - Admin/Manager/Supervisor: todas as OS
      // - Consultant/Technician: apenas OS que criou
      // Nota: assignedTo ainda não está implementado na UI, então técnicos
      // são limitados às OS que criaram. Quando implementado, adicionar:
      // || resource.data.assignedTo.id == request.auth.uid
      // ──────────────────────────────────────────────────────────────────────
      match /orders/{orderId} {
        // Leitura: membros podem ler, exceto consultores/técnicos que só veem as próprias
        allow read: if belongsToCompany(companyId) && (
          hasRole(companyId, 'admin')
          || hasRole(companyId, 'manager')
          || hasRole(companyId, 'supervisor')
          || resource.data.createdBy.id == request.auth.uid
        );

        // Criação: admin, supervisor, consultant
        allow create: if canManageOrders(companyId);

        // Atualização: depende do perfil e do tipo de alteração
        allow update: if belongsToCompany(companyId) && (
          // Admin pode tudo
          isCompanyAdmin(companyId)
          // Manager pode editar (ajustes financeiros)
          || hasRole(companyId, 'manager')
          // Supervisor pode gerenciar todas as OS
          || hasRole(companyId, 'supervisor')
          // Consultant pode editar suas próprias OS
          || (hasRole(companyId, 'consultant') && resource.data.createdBy.id == request.auth.uid)
          // Technician pode atualizar apenas suas próprias OS (assignedTo não implementado ainda)
          || (hasRole(companyId, 'technician') && resource.data.createdBy.id == request.auth.uid)
        );

        // Deleção:
        // - Admin: sempre pode
        // - Supervisor e Gerente: apenas status 'quote'
        // - Consultant e Technician: apenas se criador e status 'quote'
        allow delete: if belongsToCompany(companyId) && (
          isCompanyAdmin(companyId)
          || (
            (hasRole(companyId, 'supervisor') || hasRole(companyId, 'manager'))
            && resource.data.status == 'quote'
          )
          || (
            resource.data.createdBy.id == request.auth.uid
            && resource.data.status == 'quote'
            && (hasRole(companyId, 'consultant') || hasRole(companyId, 'technician'))
          )
        );

        // Subcollection de fotos dentro de orders
        match /photos/{photoId} {
          allow read: if belongsToCompany(companyId);
          allow write: if belongsToCompany(companyId);
        }

        // Subcollection de formulários dentro de orders
        match /forms/{formId} {
          allow read: if belongsToCompany(companyId);
          allow write: if belongsToCompany(companyId);
        }

        // Subcollection de comentários dentro de orders
        // Membros podem ler todos os comentários (internos e públicos)
        // Membros podem criar/atualizar comentários
        // Comentários de clientes via magic link são criados via Cloud Functions (Admin SDK)
        match /comments/{commentId} {
          allow read: if belongsToCompany(companyId);
          allow create: if belongsToCompany(companyId);
          allow update: if belongsToCompany(companyId)
            && resource.data.author.userId == request.auth.uid;
          allow delete: if isCompanyAdmin(companyId)
            || resource.data.author.userId == request.auth.uid;
        }
      }

      // ──────────────────────────────────────────────────────────────────────
      // CLIENTES
      // Todos podem visualizar, apenas admin/supervisor/consultant podem editar
      // ──────────────────────────────────────────────────────────────────────
      match /customers/{customerId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageCustomers(companyId);
      }

      // ──────────────────────────────────────────────────────────────────────
      // DISPOSITIVOS/EQUIPAMENTOS
      // Todos podem visualizar, apenas admin/supervisor podem editar
      // ──────────────────────────────────────────────────────────────────────
      match /devices/{deviceId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageDevices(companyId);
      }

      // ──────────────────────────────────────────────────────────────────────
      // PRODUTOS E SERVIÇOS (CATÁLOGO)
      // Todos podem visualizar, apenas admin/supervisor podem editar
      // ──────────────────────────────────────────────────────────────────────
      match /products/{productId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageCompany(companyId);
      }

      match /services/{serviceId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageCompany(companyId);
      }

      // ──────────────────────────────────────────────────────────────────────
      // MEMBERSHIPS (COLABORADORES)
      // Todos podem visualizar, admin pode gerenciar, usuário pode criar próprio
      // ──────────────────────────────────────────────────────────────────────
      match /memberships/{memberId} {
        allow read: if belongsToCompany(companyId);
        // Permite criar seu próprio membership (signup) ou owner/admin gerenciar outros
        allow create: if request.auth != null
          && (
            request.auth.uid == memberId  // Self-membership (signup)
            || isCompanyAdmin(companyId)
          );
        // Update/delete apenas owner ou admin
        allow update, delete: if request.auth != null
          && (
            get(/databases/$(database)/documents/companies/$(companyId)).data.owner.id == request.auth.uid
            || isCompanyAdmin(companyId)
          );
      }

      // ──────────────────────────────────────────────────────────────────────
      // MARCAS E CATÁLOGO DE DISPOSITIVOS
      // ──────────────────────────────────────────────────────────────────────
      match /brands/{brandId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageCompany(companyId);
      }

      match /deviceCatalog/{itemId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageCompany(companyId);
      }

      // ──────────────────────────────────────────────────────────────────────
      // TEMPLATES DE FORMULÁRIOS
      // Todos podem visualizar, apenas admin/supervisor podem gerenciar
      // ──────────────────────────────────────────────────────────────────────
      match /forms/{formId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageTemplates(companyId);
      }

      // ──────────────────────────────────────────────────────────────────────
      // VALORES ACUMULADOS (autocomplete de campos)
      // Todos podem visualizar e adicionar, apenas admin pode remover
      // ──────────────────────────────────────────────────────────────────────
      match /accumulatedFields/{fieldType}/values/{valueId} {
        allow read: if belongsToCompany(companyId);
        allow create, update: if belongsToCompany(companyId);
        allow delete: if canManageCompany(companyId);
      }

      // ──────────────────────────────────────────────────────────────────────
      // NOTIFICAÇÕES IN-APP
      // Usuário pode ler/atualizar apenas suas próprias notificações
      // Criação apenas via Cloud Functions (Admin SDK)
      // ──────────────────────────────────────────────────────────────────────
      match /notifications/{notificationId} {
        // Leitura: membro da empresa pode ler suas próprias notificações
        allow read: if belongsToCompany(companyId)
          && resource.data.recipientId == request.auth.uid;

        // Atualização: apenas para marcar como lida (próprias notificações)
        allow update: if belongsToCompany(companyId)
          && resource.data.recipientId == request.auth.uid
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);

        // Criação e deleção: apenas via Cloud Functions (Admin SDK)
        allow create, delete: if false;
      }
    }
  }
}
