rules_version = '2';
service cloud.firestore {

  match /databases/{database}/documents {

    // ════════════════════════════════════════════════════════════════════════
    // HELPER FUNCTIONS - RBAC (Role-Based Access Control)
    // ════════════════════════════════════════════════════════════════════════
    //
    // User roles in PraticOS:
    // - admin: Administrator - Full system access
    // - manager: Manager (Financial) - Financial management
    // - supervisor: Supervisor - Operational management
    // - consultant: Consultant (Sales) - Commercial profile
    // - technician: Technician - Service execution
    // ════════════════════════════════════════════════════════════════════════

    // Verifica se o usuário pertence à empresa usando custom claims
    function belongsToCompany(companyId) {
      return request.auth != null
        && request.auth.token.roles != null
        && request.auth.token.roles[companyId] != null;
    }

    // Verifica se o usuário tem uma role específica na empresa
    function hasRole(companyId, role) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] == role;
    }

    // Verifica se o usuário é admin da empresa
    function isCompanyAdmin(companyId) {
      return hasRole(companyId, 'admin');
    }

    // Verifica se o usuário pode gerenciar a empresa (admin apenas)
    function canManageCompany(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] == 'admin';
    }

    // Verifica se o usuário pode gerenciar dispositivos (admin, manager ou supervisor)
    function canManageDevices(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'manager', 'supervisor'];
    }

    // Verifica se o usuário pode visualizar dados financeiros (admin ou manager)
    function canViewFinancial(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'manager'];
    }

    // Verifica se o usuário pode gerenciar usuários (apenas admin)
    function canManageUsers(companyId) {
      return isCompanyAdmin(companyId);
    }

    // Verifica se o usuário pode criar/editar OS (admin, supervisor, consultant, technician)
    function canManageOrders(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'supervisor', 'consultant', 'technician'];
    }

    // Verifica se o usuário pode executar OS (todos os perfis)
    function canExecuteOrders(companyId) {
      return belongsToCompany(companyId);
    }

    // Verifica se o usuário pode atribuir técnicos (admin, supervisor)
    function canAssignOrders(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'supervisor'];
    }

    // Verifica se o usuário pode gerenciar templates (admin, supervisor)
    function canManageTemplates(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'supervisor'];
    }

    // Verifica se é o owner da empresa (para estrutura legada)
    function isOwner() {
      return request.auth != null
        && resource.data.company.id == request.auth.uid;
    }

    // Verifica se é o owner da empresa (para create)
    function isOwnerOnCreate() {
      return request.auth != null
        && request.resource.data.company['id'] == request.auth.uid;
    }

    // ════════════════════════════════════════════════════════════════════════
    // GLOBAL COLLECTIONS
    // ════════════════════════════════════════════════════════════════════════

    // Users - global collection (usuário pode pertencer a múltiplas empresas)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Invites - convites para colaboradores
    // Apenas admin pode criar/gerenciar convites (conforme RBAC: PermissionType.manageUsers)
    // O convidado pode ler convites direcionados ao seu email
    // O convidado pode atualizar status (aceitar/rejeitar)
    match /invites/{inviteId} {
      // Permite criar se autenticado e é admin da empresa do convite
      allow create: if request.auth != null
        && request.resource.data.company != null
        && request.resource.data.company.id != null
        && canManageUsers(request.resource.data.company.id);

      // Permite ler se é o dono do convite (email) ou admin da empresa
      // Nota: novos usuários podem não ter claims ainda, então verificamos email diretamente
      allow read: if request.auth != null
        && (
          request.auth.token.email == resource.data.email
          || (
            resource.data.company != null
            && resource.data.company.id != null
            && canManageUsers(resource.data.company.id)
          )
        );

      // Permite atualizar status se é o dono do convite (email)
      allow update: if request.auth != null
        && request.auth.token.email == resource.data.email
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']);

      // Permite deletar se é admin da empresa
      allow delete: if request.auth != null
        && resource.data.company != null
        && resource.data.company.id != null
        && canManageUsers(resource.data.company.id);
    }

    // Segments - global collection (read-only para usuários autenticados)
    match /segments/{segmentId} {
      allow read: if request.auth != null;
      allow write: if false; // Apenas via Admin SDK (script de seed)

      // Formulários globais do segmento (read-only)
      match /forms/{formId} {
        allow read: if request.auth != null;
        allow write: if false; // Apenas via Admin SDK (script de seed)
      }
    }

    // ════════════════════════════════════════════════════════════════════════
    // LEGACY STRUCTURE (manter durante migração)
    // Remover após cleanup completo
    // ════════════════════════════════════════════════════════════════════════

    match /companies/{id} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && (
        resource.data.owner == request.auth.uid ||
        (resource.data.owner is map && resource.data.owner.id == request.auth.uid)
      );
    }

    match /customers/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /devices/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /orders/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /products/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /services/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /roles/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    // ════════════════════════════════════════════════════════════════════════
    // NEW SUBCOLLECTION STRUCTURE - RBAC
    // Usa custom claims para verificação de acesso granular
    // ════════════════════════════════════════════════════════════════════════

    match /companies/{companyId} {
      // Documento da empresa - membros podem ler, apenas owner/admin pode escrever
      allow read: if belongsToCompany(companyId)
        || resource.data.owner == request.auth.uid
        || (resource.data.owner is map && resource.data.owner.id == request.auth.uid);

      allow write: if request.auth != null
        && (
          resource.data.owner == request.auth.uid
          || (resource.data.owner is map && resource.data.owner.id == request.auth.uid)
          || isCompanyAdmin(companyId)
        );

      // ──────────────────────────────────────────────────────────────────────
      // ORDENS DE SERVIÇO
      // Acesso baseado em perfil:
      // - Admin/Manager/Supervisor: todas as OS
      // - Consultant: apenas OS que criou
      // - Technician: qualquer OS da empresa (assignedTo ainda não está funcional)
      // ──────────────────────────────────────────────────────────────────────
      match /orders/{orderId} {
        // Leitura: todos os membros podem ler (filtro feito no app)
        allow read: if belongsToCompany(companyId);

        // Criação: admin, supervisor, consultant
        allow create: if canManageOrders(companyId);

        // Atualização: depende do perfil e do tipo de alteração
        allow update: if belongsToCompany(companyId) && (
          // Admin pode tudo
          isCompanyAdmin(companyId)
          // Manager pode editar (ajustes financeiros)
          || hasRole(companyId, 'manager')
          // Supervisor pode gerenciar todas as OS
          || hasRole(companyId, 'supervisor')
          // Manager pode apenas visualizar (sem write)
          // Consultant pode editar suas próprias OS
          || (hasRole(companyId, 'consultant') && resource.data.createdBy.id == request.auth.uid)
          // Technician pode atualizar qualquer OS da empresa (assignedTo ainda não está funcional)
          || hasRole(companyId, 'technician')
        );

        // Deleção:
        // - Admin e Supervisor podem deletar (via canAssignOrders)
        // - Consultant e Technician podem deletar apenas OS que criaram, em status 'quote'
        allow delete: if belongsToCompany(companyId) && (
          canAssignOrders(companyId)
          || (
            // Permite deletar se é o criador e status é 'quote'
            resource.data.createdBy != null
            && resource.data.createdBy.id == request.auth.uid
            && resource.data.status == 'quote'
            && (
              hasRole(companyId, 'consultant')
              || hasRole(companyId, 'technician')
            )
          )
        );

        // Subcollection de fotos dentro de orders
        match /photos/{photoId} {
          allow read: if belongsToCompany(companyId);
          allow write: if belongsToCompany(companyId);
        }

        // Subcollection de formulários dentro de orders
        match /forms/{formId} {
          allow read: if belongsToCompany(companyId);
          allow write: if belongsToCompany(companyId);
        }
      }

      // ──────────────────────────────────────────────────────────────────────
      // CLIENTES
      // Todos podem visualizar, apenas admin/supervisor/consultant podem editar
      // ──────────────────────────────────────────────────────────────────────
      match /customers/{customerId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageOrders(companyId);
      }

      // ──────────────────────────────────────────────────────────────────────
      // DISPOSITIVOS/EQUIPAMENTOS
      // Todos podem visualizar, apenas admin/supervisor podem editar
      // ──────────────────────────────────────────────────────────────────────
      match /devices/{deviceId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageDevices(companyId);
      }

      // ──────────────────────────────────────────────────────────────────────
      // PRODUTOS E SERVIÇOS (CATÁLOGO)
      // Todos podem visualizar, apenas admin/supervisor podem editar
      // ──────────────────────────────────────────────────────────────────────
      match /products/{productId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageCompany(companyId);
      }

      match /services/{serviceId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageCompany(companyId);
      }

      // ──────────────────────────────────────────────────────────────────────
      // MEMBERSHIPS (COLABORADORES)
      // Todos podem visualizar, admin pode gerenciar, usuário pode criar próprio
      // ──────────────────────────────────────────────────────────────────────
      match /memberships/{memberId} {
        allow read: if belongsToCompany(companyId);
        // Permite criar seu próprio membership (signup) ou owner/admin gerenciar outros
        allow create: if request.auth != null
          && (
            request.auth.uid == memberId  // Self-membership (signup)
            || isCompanyAdmin(companyId)
          );
        // Update/delete apenas owner ou admin
        allow update, delete: if request.auth != null
          && (
            get(/databases/$(database)/documents/companies/$(companyId)).data.owner.id == request.auth.uid
            || isCompanyAdmin(companyId)
          );
      }

      // ──────────────────────────────────────────────────────────────────────
      // MARCAS E CATÁLOGO DE DISPOSITIVOS
      // ──────────────────────────────────────────────────────────────────────
      match /brands/{brandId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageCompany(companyId);
      }

      match /deviceCatalog/{itemId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageCompany(companyId);
      }

      // ──────────────────────────────────────────────────────────────────────
      // TEMPLATES DE FORMULÁRIOS
      // Todos podem visualizar, apenas admin/supervisor podem gerenciar
      // ──────────────────────────────────────────────────────────────────────
      match /forms/{formId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageTemplates(companyId);
      }
    }
  }
}
