rules_version = '2';
service cloud.firestore {

  match /databases/{database}/documents {

    // ════════════════════════════════════════════════════════════════════════
    // HELPER FUNCTIONS - RBAC (Role-Based Access Control)
    // ════════════════════════════════════════════════════════════════════════
    //
    // Perfis de usuário no PraticOS:
    // - admin: Administrador - Acesso total ao sistema
    // - gerente: Gerente (Financeiro) - Gestão financeira
    // - supervisor: Supervisor - Gestão operacional
    // - consultor: Consultor (Vendedor) - Perfil comercial
    // - tecnico: Técnico - Execução de serviços
    //
    // Roles legados (normalizados na Cloud Function):
    // - manager -> supervisor
    // - user -> tecnico
    // ════════════════════════════════════════════════════════════════════════

    // Verifica se o usuário pertence à empresa usando custom claims
    function belongsToCompany(companyId) {
      return request.auth != null
        && request.auth.token.roles != null
        && request.auth.token.roles[companyId] != null;
    }

    // Verifica se o usuário tem uma role específica na empresa
    function hasRole(companyId, role) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] == role;
    }

    // Verifica se o usuário é admin da empresa
    function isCompanyAdmin(companyId) {
      return hasRole(companyId, 'admin');
    }

    // Verifica se o usuário pode gerenciar a empresa (admin ou supervisor)
    function canManageCompany(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'supervisor'];
    }

    // Verifica se o usuário pode visualizar dados financeiros (admin ou gerente)
    function canViewFinancial(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'gerente'];
    }

    // Verifica se o usuário pode gerenciar usuários (apenas admin)
    function canManageUsers(companyId) {
      return isCompanyAdmin(companyId);
    }

    // Verifica se o usuário pode criar/editar OS (admin, supervisor, consultor)
    function canManageOrders(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'supervisor', 'consultor'];
    }

    // Verifica se o usuário pode executar OS (todos os perfis)
    function canExecuteOrders(companyId) {
      return belongsToCompany(companyId);
    }

    // Verifica se o usuário pode atribuir técnicos (admin, supervisor)
    function canAssignOrders(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'supervisor'];
    }

    // Verifica se o usuário pode gerenciar templates (admin, supervisor)
    function canManageTemplates(companyId) {
      return belongsToCompany(companyId)
        && request.auth.token.roles[companyId] in ['admin', 'supervisor'];
    }

    // Verifica se é o owner da empresa (para estrutura legada)
    function isOwner() {
      return request.auth != null
        && resource.data.company.id == request.auth.uid;
    }

    // Verifica se é o owner da empresa (para create)
    function isOwnerOnCreate() {
      return request.auth != null
        && request.resource.data.company['id'] == request.auth.uid;
    }

    // ════════════════════════════════════════════════════════════════════════
    // GLOBAL COLLECTIONS
    // ════════════════════════════════════════════════════════════════════════

    // Users - global collection (usuário pode pertencer a múltiplas empresas)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Segments - global collection (read-only para usuários autenticados)
    match /segments/{segmentId} {
      allow read: if request.auth != null;
      allow write: if false; // Apenas via Admin SDK (script de seed)

      // Formulários globais do segmento (read-only)
      match /forms/{formId} {
        allow read: if request.auth != null;
        allow write: if false; // Apenas via Admin SDK (script de seed)
      }
    }

    // ════════════════════════════════════════════════════════════════════════
    // LEGACY STRUCTURE (manter durante migração)
    // Remover após cleanup completo
    // ════════════════════════════════════════════════════════════════════════

    match /companies/{id} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && (
        resource.data.owner == request.auth.uid ||
        (resource.data.owner is map && resource.data.owner.id == request.auth.uid)
      );
    }

    match /customers/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /devices/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /orders/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /products/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /services/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    match /roles/{id} {
      allow create: if isOwnerOnCreate();
      allow read, write: if isOwner();
    }

    // ════════════════════════════════════════════════════════════════════════
    // NEW SUBCOLLECTION STRUCTURE - RBAC
    // Usa custom claims para verificação de acesso granular
    // ════════════════════════════════════════════════════════════════════════

    match /companies/{companyId} {
      // Documento da empresa - membros podem ler, apenas owner/admin pode escrever
      allow read: if belongsToCompany(companyId)
        || resource.data.owner == request.auth.uid
        || (resource.data.owner is map && resource.data.owner.id == request.auth.uid);

      allow write: if request.auth != null
        && (
          resource.data.owner == request.auth.uid
          || (resource.data.owner is map && resource.data.owner.id == request.auth.uid)
          || isCompanyAdmin(companyId)
        );

      // ──────────────────────────────────────────────────────────────────────
      // ORDENS DE SERVIÇO
      // Acesso baseado em perfil:
      // - Admin/Gerente/Supervisor: todas as OS
      // - Consultor: apenas OS que criou
      // - Técnico: apenas OS atribuídas
      // ──────────────────────────────────────────────────────────────────────
      match /orders/{orderId} {
        // Leitura: todos os membros podem ler (filtro feito no app)
        allow read: if belongsToCompany(companyId);

        // Criação: admin, supervisor, consultor
        allow create: if canManageOrders(companyId);

        // Atualização: depende do perfil e do tipo de alteração
        allow update: if belongsToCompany(companyId) && (
          // Admin pode tudo
          isCompanyAdmin(companyId)
          // Supervisor pode gerenciar todas as OS
          || hasRole(companyId, 'supervisor')
          // Gerente pode apenas visualizar (sem write)
          // Consultor pode editar suas próprias OS
          || (hasRole(companyId, 'consultor') && resource.data.createdBy == request.auth.uid)
          // Técnico pode atualizar OS atribuídas (status, formulários, fotos)
          || (hasRole(companyId, 'tecnico') && (
            resource.data.assignedTo.id == request.auth.uid
            || resource.data.createdBy == request.auth.uid
          ))
        );

        // Deleção: apenas admin e supervisor
        allow delete: if canAssignOrders(companyId);

        // Subcollection de fotos dentro de orders
        match /photos/{photoId} {
          allow read: if belongsToCompany(companyId);
          allow write: if belongsToCompany(companyId);
        }

        // Subcollection de formulários dentro de orders
        match /forms/{formId} {
          allow read: if belongsToCompany(companyId);
          allow write: if belongsToCompany(companyId);
        }
      }

      // ──────────────────────────────────────────────────────────────────────
      // CLIENTES
      // Todos podem visualizar, apenas admin/supervisor/consultor podem editar
      // ──────────────────────────────────────────────────────────────────────
      match /customers/{customerId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageOrders(companyId);
      }

      // ──────────────────────────────────────────────────────────────────────
      // DISPOSITIVOS/EQUIPAMENTOS
      // Todos podem visualizar, apenas admin/supervisor podem editar
      // ──────────────────────────────────────────────────────────────────────
      match /devices/{deviceId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageCompany(companyId);
      }

      // ──────────────────────────────────────────────────────────────────────
      // PRODUTOS E SERVIÇOS (CATÁLOGO)
      // Todos podem visualizar, apenas admin/supervisor podem editar
      // ──────────────────────────────────────────────────────────────────────
      match /products/{productId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageCompany(companyId);
      }

      match /services/{serviceId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageCompany(companyId);
      }

      // ──────────────────────────────────────────────────────────────────────
      // MEMBERSHIPS (COLABORADORES)
      // Todos podem visualizar, apenas admin pode gerenciar
      // ──────────────────────────────────────────────────────────────────────
      match /memberships/{userId} {
        allow read: if belongsToCompany(companyId);
        allow write: if request.auth != null
          && (
            get(/databases/$(database)/documents/companies/$(companyId)).data.owner.id == request.auth.uid
            || isCompanyAdmin(companyId)
          );
      }

      // ──────────────────────────────────────────────────────────────────────
      // MARCAS E CATÁLOGO DE DISPOSITIVOS
      // ──────────────────────────────────────────────────────────────────────
      match /brands/{brandId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageCompany(companyId);
      }

      match /deviceCatalog/{itemId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageCompany(companyId);
      }

      // ──────────────────────────────────────────────────────────────────────
      // TEMPLATES DE FORMULÁRIOS
      // Todos podem visualizar, apenas admin/supervisor podem gerenciar
      // ──────────────────────────────────────────────────────────────────────
      match /forms/{formId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageTemplates(companyId);
      }

      // Legado: form_templates (pode ser removido após migração)
      match /form_templates/{formId} {
        allow read: if belongsToCompany(companyId);
        allow write: if canManageTemplates(companyId);
      }
    }
  }
}
