default_platform(:ios)

platform :ios do
  desc "Build + upload para TestFlight (sem match)"
  lane :beta do
    app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_API_KEY_ISSUER_ID'],
      key_content: ENV['APP_STORE_CONNECT_API_KEY_PRIVATE_KEY']
    )

    # numera√ß√£o do build (ex.: √∫ltima + 1)
    increment_build_number(
      build_number: latest_testflight_build_number + 1
    )

    # üîß for√ßa assinatura s√≥ no Runner (Release)
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Runner.xcodeproj",
      targets: ["Runner"],
      build_configurations: ["Release"],
      team_id: ENV['DEVELOPMENT_TEAM'],
      code_sign_identity: "Apple Distribution",
      profile_name: ENV['PROFILE_NAME'],   # nome do .mobileprovision (o "Name" extra√≠do)
      profile_uuid: ENV['PROFILE_UUID']    # opcional, ajuda a fixar
    )

    # üèóÔ∏è archive + export (sem passar PROVISIONING_* em xcargs)
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      configuration: "Release",
      export_method: "app-store",
      skip_profile_detection: true,
      export_options: {
        signingStyle: "manual",
        provisioningProfiles: {
          ENV['BUNDLE_ID'] => ENV['PROFILE_NAME']
        }
      },
      # xcargs m√≠nimos: time/team, sem perfis
      xcargs: "DEVELOPMENT_TEAM=#{ENV['DEVELOPMENT_TEAM']} CODE_SIGN_STYLE=Manual"
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )
  end

  desc "S√≥ envia o √∫ltimo .ipa"
  lane :upload do
    upload_to_testflight(skip_waiting_for_build_processing: true)
  end
end
